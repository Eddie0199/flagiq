workflows:
  ios-capacitor:
    name: iOS Capacitor (TestFlight)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - appstore_connect
      node: 22
      vars:
        BUNDLE_IDENTIFIER: com.wildmoustachegames.flagiq
        XCODE_WORKSPACE: ios/App/App.xcworkspace
        XCODE_SCHEME: App
        IOS_BUILD_NUMBER: 34
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.wildmoustachegames.flagiq
    scripts:
      - name: Install dependencies
        script: npm ci
      - name: Build web app
        script: |
          if [[ -z "${REACT_APP_SUPABASE_URL:-}" || -z "${REACT_APP_SUPABASE_ANON_KEY:-}" ]]; then
            echo "Missing required env vars for build: REACT_APP_SUPABASE_URL and/or REACT_APP_SUPABASE_ANON_KEY"
            exit 1
          fi
          npx cross-env ESLINT_NO_DEV_ERRORS=true npm run build
      - name: Copy Capacitor web assets to iOS (without native project regeneration)
        script: npx cap copy ios
      - name: Install iOS pods
        script: |
          cd ios/App
          pod install

      - name: Verify native build marker injection after Capacitor copy
        script: |
          set -euo pipefail
          MARKER="NATIVE_MARKER_2026-02-14-A"
          if ! grep -n "$MARKER" ios/App/App/AppBridgeViewController.swift; then
            echo "❌ Native marker $MARKER missing from AppBridgeViewController.swift"
            exit 1
          fi
          echo "✅ Native marker $MARKER present after Capacitor copy"
      - name: Verify iOS plugin shim file exists in repo
        script: |
          set -euo pipefail
          SHIM_PATH="ios/App/App/StoreKitPurchasePlugin.m"
          if [[ ! -f "$SHIM_PATH" ]]; then
            echo "❌ Missing shim source file at $SHIM_PATH"
            exit 1
          fi
          echo "✅ Found shim source file at $SHIM_PATH"
      - name: Verify shim target membership after Capacitor sync
        script: |
          set -euo pipefail
          PBXPROJ="ios/App/App.xcodeproj/project.pbxproj"
          if ! grep -nE "StoreKitPurchasePlugin\\.m in Sources" "$PBXPROJ"; then
            echo "❌ StoreKitPurchasePlugin.m is not in App target Sources build phase"
            exit 1
          fi
          if ! grep -nE "path = StoreKitPurchasePlugin\\.m;" "$PBXPROJ"; then
            echo "❌ StoreKitPurchasePlugin.m file reference missing from Xcode project"
            exit 1
          fi
          echo "✅ StoreKitPurchasePlugin.m is referenced and in Sources after cap sync"
      - name: Print workspace schemes and selected scheme
        script: |
          set -euo pipefail
          echo "xcodebuild -list -workspace $XCODE_WORKSPACE"
          xcodebuild -list -workspace "$XCODE_WORKSPACE"
          echo "Selected archive scheme: $XCODE_SCHEME"
      - name: Initialize keychain
        script: keychain initialize
      - name: Configure code signing
        script: |
          app_store_connect fetch-signing-files "$BUNDLE_IDENTIFIER" --type IOS_APP_STORE --create
          keychain add-certificates
          xcode-project use-profiles
      - name: Set iOS build versions
        script: |
          MARKETING_VERSION="${MARKETING_VERSION:-1.0}"
          CURRENT_PROJECT_VERSION="${CM_BUILD_NUMBER:-$IOS_BUILD_NUMBER}"
          echo "MARKETING_VERSION=$MARKETING_VERSION" >> "$CM_ENV"
          echo "CURRENT_PROJECT_VERSION=$CURRENT_PROJECT_VERSION" >> "$CM_ENV"
          BUILD_SETTINGS=$(xcodebuild -showBuildSettings -workspace "$XCODE_WORKSPACE" -scheme "$XCODE_SCHEME" -configuration Release -target "$XCODE_SCHEME")
          INFO_PLIST_RELATIVE=$(echo "$BUILD_SETTINGS" | awk -F ' = ' '/INFOPLIST_FILE/ {print $2; exit}')
          WORKSPACE_DIR=$(dirname "$XCODE_WORKSPACE")
          if [[ "$INFO_PLIST_RELATIVE" = /* ]]; then
            INFO_PLIST="$INFO_PLIST_RELATIVE"
          else
            INFO_PLIST="$WORKSPACE_DIR/$INFO_PLIST_RELATIVE"
          fi
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $MARKETING_VERSION" "$INFO_PLIST" || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string $MARKETING_VERSION" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $CURRENT_PROJECT_VERSION" "$INFO_PLIST" || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string $CURRENT_PROJECT_VERSION" "$INFO_PLIST"
          echo "Resolved Info.plist: $INFO_PLIST"
          echo "Bundle identifier: $(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$INFO_PLIST")"
          echo "CFBundleShortVersionString: $(/usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "$INFO_PLIST")"
          echo "CFBundleVersion: $(/usr/libexec/PlistBuddy -c 'Print :CFBundleVersion' "$INFO_PLIST")"
          echo "Final CFBundleVersion (App target): $(/usr/libexec/PlistBuddy -c 'Print :CFBundleVersion' "$INFO_PLIST")"
      - name: Set iOS build number
        script: |
          #!/usr/bin/env bash
          set -e

          BUILD_NUMBER="${CM_BUILD_NUMBER:-$IOS_BUILD_NUMBER}"
          echo "BUILD_NUMBER=$BUILD_NUMBER"

          INFO_PLIST="ios/App/App/Info.plist"

          # Set build number (CFBundleVersion)
           /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$INFO_PLIST" \
           || /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string $BUILD_NUMBER" "$INFO_PLIST"

          # Print to confirm
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$INFO_PLIST" || true
          /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$INFO_PLIST" || true
      - name: Build IPA
        script: |
          xcode-project build-ipa --workspace "$XCODE_WORKSPACE" --scheme "$XCODE_SCHEME"
      - name: Verify StoreKitPurchasePlugin.m compiled in archive
        script: |
          set -euo pipefail
          LATEST_LOG="$(ls -t /tmp/xcodebuild_logs/*.log | head -n 1)"
          echo "Inspecting xcodebuild log: $LATEST_LOG"
          if ! grep -nE "CompileC.*StoreKitPurchasePlugin\\.m" "$LATEST_LOG"; then
            echo "❌ StoreKitPurchasePlugin.m was not compiled into the archive target"
            exit 1
          fi
          echo "✅ Found CompileC line for StoreKitPurchasePlugin.m"
      - name: Print archive verification excerpt
        script: |
          set -euo pipefail
          LATEST_LOG="$(ls -t /tmp/xcodebuild_logs/*.log | head -n 1)"
          echo "----- CI verification excerpt -----"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Scheme: $XCODE_SCHEME"
          echo "Shim compile lines:"
          grep -nE "CompileC.*StoreKitPurchasePlugin\\.m" "$LATEST_LOG"
          echo "-----------------------------------"
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_API_KEY
        key_id: $APP_STORE_CONNECT_KEY_ID
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
